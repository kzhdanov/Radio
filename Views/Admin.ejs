<!DOCTYPE html>
<html lang="en">
  <head>
      <title>Radio Admin</title>
      <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name="viewport" content="width=device-width, user-scalable=no" />
      <meta name="description" content="" />
      <meta name="keywords" content="" />
      <meta name="author" content="" />
      <link rel="stylesheet" type="text/css" href="/css/toastr.min.css" />
      <link rel="stylesheet" type="text/css" href="/Bootstrap/css/bootstrap.min.css" />
  </head>
  <body style="background-image:url('./images/adminback.jpg');">
    <div class="container-fluid">
    <div class="row">
      <div class="col-md-10 col-md-offset-1">
        <h1><small>Альбомы</small></h1>
        <div class="col-md-2" style="padding-left:0">
          <input type="number" class="form-control" name="WeekNumberSearch" id="WeekNumberSearch" placeholder="№ недели для поиска">
        </div>
        <div class="col-md-2">
          <button class="btn btn-default" id="Search">Поиск</button>
        </div>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Неделя</th>
              <th>Дата публикации</th>
              <th>Группа</th>
              <th>Альбом</th>
              <th>Отображается на сайте?</th>
              <th>Картинка</ht>
              <th style="width:10%">Действия</th>
            </tr>
          </thead>
          <tbody>
            <% include AdminPartial.ejs %>
          </tbody>
        </table>
      </div>
    </div>
    <hr/>
    <div class="row">
      <div class="col-md-7 col-md-offset-2">
        <h1><small>Создать новую статью на сайте</small></h1>
        <form id="AddAlbumInfo" class="form-horizontal"/>
        <div class="form-group">
          <label for="WeekNumber" class="col-sm-2 control-label">Номер недели</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" name="WeekNumber" id="WeekNumber" placeholder="№ недели (он связывает альбомы)">
          </div>
        </div>
          <div class="form-group">
            <label for="BandName" class="col-sm-2 control-label">Название группы</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="BandName" id="BandName" placeholder="Группа (Название должно быть точно как в стриме иначе рейтинг не вытянуть)">
            </div>
          </div>
          <div class="form-group">
            <label for="AlbumName" class="col-sm-2 control-label">Название альбома</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="AlbumName" id="AlbumName" placeholder="Альбом (Название должно быть точно как в стриме иначе рейтинг не вытянуть)">
            </div>
          </div>
          <div class="form-group">
            <label for="Genres" class="col-sm-2 control-label">Жанры</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="Genres" id="Genres" placeholder="Жанр или жанры (через запятую)">
            </div>
          </div>
          <div class="form-group">
            <label for="Year" class="col-sm-2 control-label">Дата выхода альбома</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="Year" id="Year" placeholder="Дата выхода альбома">
            </div>
          </div>
          <div class="form-group">
            <label for="preView" class="col-sm-2 control-label">Превью</label>
            <div class="col-sm-10">
              <textarea class="form-control" name="preView" id="preView" placeholder="Превью" rows="3"></textarea>
            </div>
          </div>
          <div class="form-group">
            <label for="mainText" class="col-sm-2 control-label">Основной текст статьи</label>
            <div class="col-sm-10">
              <textarea class="form-control" name="mainText" id="mainText" placeholder="Основной текст статьи" rows="20"></textarea>
            </div>
          </div>
          <div class="form-group">
            <label for="ImgName" class="col-sm-2 control-label">Название картинки альбома</label>
            <div class="col-sm-10">
              <span>Картинка будет браться из папки '~/Автор/Альбом/cover.jpg' ты можешь тут исправить имя и расширение картинки</span>
              <input type="text" class="form-control" name="ImgName" id="ImgName" placeholder="aa" value="cover.jpg">
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <div class="checkbox">
                <label>
                  <input type="checkbox" name="IsVisible" id="IsVisible"> Видимая статья?
                </label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button class="btn btn-default" id="Save">Опубликовать</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    </div>
    <script src="/build/jquery3.0.0.min.js" type="text/javascript"></script>
    <script src="/build/toastr.min.js" type="text/javascript"></script>
    <script src="/Bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    <script>
      (function () {
        $('#Save').click(function (e) {
          e.preventDefault();
          var _self = $(this);
          _self.hide();

          if (!$('#Save').attr('data-id') && $('#Save').attr('data-id') !== '') {
            $.ajax({
              method: 'POST',
              async: true,
              data: { album: $('#AddAlbumInfo').serialize() },
              url: '/RadioAdmin/Save',
            }).done(function (data) {
              _self.show();
              if (data.type === 'success')
                toastr.success('Все успешно сохранилось');
              else
                toastr.error('Ошибка в процессе сохранения...');
            }).fail(function (ex) {
              _self.show();
              toastr.error('Oh, something went wrong...');
            });
          } else {
            var str = $('#AddAlbumInfo').serialize() + '&id=' + $('#Save').attr('data-id');
            $.ajax({
              method: 'POST',
              async: true,
              data: { album: str },
              url: '/RadioAdmin/EditSave',
            }).done(function (data) {
              _self.show();
              $('#Save').removeAttr('data-id');
              if (data.type === 'success')
                toastr.success('Изменения внесены успешно');
              else
                toastr.error('Ошибка в процессе сохранения редактирования...');
            }).fail(function (ex) {
              _self.show();
              $('#Save').removeAttr('data-id');
              toastr.error('Oh, something went wrong...');
            });
          }
        });

        $('#Search').click(function (e) {
          e.preventDefault();
          var _self = $( this );
          _self.hide();

          $.ajax({
            method: 'POST',
            async: true,
            cache: false,
            crossDomain: false,
            data: { week: Number($('#WeekNumberSearch').val()) },
            url: '/RadioAdmin/Get',
          }).done(function (data) {
            _self.show();
            $('table tbody').empty().html(data);
          }).fail(function (ex) {
            toastr.error('Oh, something went wrong...');
          });
        });
      })();

      function Build() {
        var _ = this.data[0];
        $('#WeekNumber').val(_.WeekNumber);
        $('#BandName').val(_.BandName);
        $('#AlbumName').val(_.AlbumName);
        $('#Genres').val(_.Genres);
        $('#Year').val(_.Year);
        $('#preView').val(_.preView);
        $('#mainText').val(_.mainText);
        $('#ImgName').val(_.ImgName);
        if (_.IsVisible)
          $('#IsVisible').prop('checked', true);
        else
          $('#IsVisible').prop('checked', false);

        $('#Save').attr('data-id', _.id);
      }

      function EditClick(e, id) {
        e.preventDefault();

        $.ajax({
          method: 'POST',
          async: true,
          cache: false,
          crossDomain: false,
          data: { id: id },
          url: '/RadioAdmin/Edit',
        }).done(function (data) {
          if (data.type === 'success') {
            Build.call(data);
          } else {
            toastr.warning('Ошибка редактирования элемента');
            $('#Save').removeAttr('data-id');
          }
        }).fail(function (ex) {
          toastr.error('Oh, something went wrong...');
          $('#Save').removeAttr('data-id');
        });
      }

      function DeleteClick(e, id) {
        e.preventDefault();

        $.ajax({
          method: 'POST',
          async: true,
          cache: false,
          crossDomain: false,
          data: { id: id },
          url: '/RadioAdmin/Delete',
        }).done(function (data) {
          if (data.type === 'success') {
            toastr.success('Элемент удален');
          } else {
            toastr.warning('Ошибка удаления элемента');
          }
        }).fail(function (ex) {
          toastr.error('Oh, something went wrong...');
        });
      }
    </script>
  </body>
</html>
