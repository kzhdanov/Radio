(function(b,c,d){c.Radio=function(e,f){this.$el=c(f);this._init(e)};c.Radio.defaults={fallbackMessage:"HTML5 audio not supported",initialVolume:0.3,url:"http://eu3.radioboss.fm:8022/live",ws:"ws://92.61.68.163:8080",};c.Radio.prototype={_init:function(g){var e=this;this.options=c.extend(true,{},c.Radio.defaults,g);this.songs="";this.$loader=this.$el.find("div.vc-loader").show();c.when(this._createPlay()).done(function(){e.$loader.hide();e._createPlayer();e._loadEvents()});var f=new WebSocket(c.Radio.defaults.ws);f.onmessage=(function(j){var h=JSON.parse(j.data);if(h.album!="no name"&&h.songName!="no name"){h.imgSrc="./RadioCovers/"+h.autor+"-"+h.album+".jpg"}else{h.imgSrc="./RadioCovers/Avance.jpg"}c(".js-group").text(h.autor);c(".js-album").text(h.album);c(".js-song").text(h.songName);c(".js-image").attr("src",h.imgSrc);var i=new c.Rating();i._clean();if(!b.Play){i.hoverOff()}else{i.hoverOn();i.ratings.off("click");i.ratings.click(i.SetClick());i.SetRating()}})},_createPlay:function(){var e=this;var f=new c.Song();c.when(f.loadMetadata()).done(function(g){e.songs=g})},_createPlayer:function(){this.$audioEl=c('<audio id="audioElem"><span>'+this.options.fallbackMessage+"</span></audio>");this.$el.prepend(this.$audioEl);this.audio=this.$audioEl.get(0);this._createControls()},_createControls:function(){var e=this;this.$controls=c('<ul class="vc-controls" style="display:none;"/>');this.$cPlay=c('<li class="vc-control-play">Play<span></span></li>');this.$cStop=c('<li class="vc-control-stop">Stop<span></span></li>');this.$controls.append(this.$cPlay).append(c('<li class="vc-control-empty"><span></span></li>')).append(this.$cStop).appendTo(this.$el);this.$volume=c('<div style="display:none;" class="vc-volume-wrap"><div class="vc-volume-control"><div class="vc-volume-knob"></div></div></div> ').appendTo(this.$el);if(document.createElement("audio").canPlayType){if(!document.createElement("audio").canPlayType("audio/mpeg")&&!document.createElement("audio").canPlayType("audio/ogg")){toastr.warning("wrong")}else{this.$controls.show();this.$volume.show();this.$volume.find("div.vc-volume-knob").knobKnob({snap:10,value:359*this.options.initialVolume,turn:function(g){e._changeVolume(g)}});this.audio.volume=this.options.initialVolume;var f=new c.NewWindowPopUp()}}},_loadEvents:function(){var e=this;this.$cPlay.on("mousedown",function(f){e._setButtonActive(c(this));e._play()});this.$cStop.on("mousedown",function(f){e._setButtonActive(c(this));e._stop()})},_setButtonActive:function(e){e.addClass("vc-control-pressed");setTimeout(function(){e.removeClass("vc-control-pressed")},100)},_prepare:function(e){this._clear();this.$audioEl.attr("src",c.Radio.defaults.url)},_updateButtons:function(f){var e="vc-control-active";this.$cPlay.removeClass(e);this.$cStop.removeClass(e);switch(f){case"play":this.$cPlay.addClass(e);break}},_changeVolume:function(e){this.audio.volume=e},_play:function(){var f=this;this._updateButtons("play");try{f._prepare(f.songs);c(this).off("canplay");f.audio.currentTime=0;f.audio.play();var g=new c.Rating();g.SetRating();g.SetClick();g.hoverOn();b.Play=true;c(".songInfo").after().addClass("animating")}catch(h){console.log(h)}},_stop:function(f){var e=new c.Rating();e.hoverOff();if(!f){this._updateButtons("stop")}this.audio.pause();c(".songInfo").after().removeClass("animating");this._clear()},_clear:function(){this.$audioEl.children("source").remove()},};c.NewWindowPopUp=function(){this._init()};c.NewWindowPopUp.prototype={newWindowEl:c(".newWindow_link"),_init:function(){this.newWindowEl.click(function(){b.open("/window/new","RadioAvance.ru","width=480,height=260,scrollbars=no,status=yes")})},};c.Rating=function(){this._init()};c.Rating.prototype={ratintDiv:c(".Rating"),ratings:c(".Rating li"),ratingTitle:c(".Rating__Title"),url:"/Rating/Save",key:"i@#4rv98*oo#a12N$_RadioKey",_init:function(){this.setOpacity(true)},SetClick:function(){var f=this,e="";this.ratings.off("click");this.ratings.click(function(){f.hoverOff();f.ratings.off("click");try{var g=localStorage.getItem(f.key);if(!g){e=f.randomGuid();localStorage.setItem(f.key,e);f.saveRating(f.buildRating.call({shortGuid:e,ratings:f.ratings}))}else{f.saveRating(f.buildRating.call({shortGuid:g,ratings:f.ratings}))}}catch(h){console.log(h)}})},SetRating:function(){var e=this;if(!localStorage.getItem(this.key)){e._clean();e.hoverOn()}else{c.ajax({method:"POST",async:true,url:"/Rating/Get",data:{user:localStorage.getItem(this.key),album:c.trim(c(".js-album").text()),group:c.trim(c(".js-group").text()),},}).done(function(g){var f=0;if(Number(g.points)!==0){for(;f<g.points;f+=1){e.ratings[f].style.backgroundColor="#333"}e.hoverOff();e.ratings.off("click")}}).fail(function(f){console.log("Oh, something went wrong...")})}},buildRating:function(){return{autor:c.trim(c(".songInfo__group").text()),song:c.trim(c(".songInfo__song").text()),album:c.trim(c(".songInfo__album").text()),rate:[].slice.call(this.ratings).filter(function(f,g){return f.style["background-color"]!=="transparent"}).length,userTempId:this.shortGuid,}},saveRating:function(e){c.ajax({method:"POST",async:true,url:this.url,data:e,}).fail(function(f){console.log("Oh, something went wrong...")})},randomGuid:function(){return"xxxxxxxx-xxxx-4xxx".replace(/[xy]/g,function(g){var f=Math.random()*16|0,e=g=="x"?f:(f&3|8);return e.toString(16)})},_clean:function(){this.ratings.css({backgroundColor:"transparent"})},hoverOn:function(){this.ratings.mouseenter(function(){var e=c(this);c(".Rating li").each(function(f,g){if(g.id<=Number(e.attr("id"))){c(this).css({backgroundColor:"#333"})}})}).mouseleave(function(){var e=c(this);c(".Rating li").each(function(f,g){if(g.id<=Number(e.attr("id"))){c(this).css({backgroundColor:"transparent"})}})})},setOpacity:function(e){if(e){this.ratintDiv.css({opacity:".8"});this.ratingTitle.css({opacity:".5"})}else{this.ratintDiv.css({opacity:".3"});this.ratingTitle.css({opacity:".3"})}},hoverOff:function(){this.setOpacity(false);this.ratings.off("mouseenter mouseleave")},};c.Song=function(){};c.Song.prototype={loadMetadata:function(){var e=this;var f=c("<audio/>");f.attr("preload","auto");f.attr("src","sounds/click.mp3");f.on("loadedmetadata",function(g){e.duration=f.get(0).duration})}};var a=function(e){toastr.error(e)};c.fn.radio=function(f){if(typeof f==="string"){var e=Array.prototype.slice.call(arguments,1);this.each(function(){var g=c.data(this,"cassette");if(!g){a("cannot call methods on cassette prior to initialization; attempted to call method '"+f+"'");return}if(!c.isFunction(g[f])||f.charAt(0)==="_"){a("no such method '"+f+"' for cassette instance");return}g[f].apply(g,e)})}else{this.each(function(){var g=c.data(this,"cassette");if(!g){c.data(this,"cassette",new c.Radio(f,this))}})}return this}})(window,jQuery);